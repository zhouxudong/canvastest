<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>过界回到初始位置</title>
    <style>
        body{background-color: #bbbbbb;}
        #mycanvas{
            background-color:#ffffff;
        }
    </style>
</head>
<body>
<canvas id="mycanvas" width="1000" height="500">浏览器不支持</canvas>

<script src="../statics/js/utils.js"></script>
<script src="../statics/js/ball.js"></script>
<script>

    var canv = document.getElementById("mycanvas"),
        cxt = canv.getContext("2d"),
        bounce = -1,
        ball0 = new Ball(80),
        ball1 = new Ball(40);

    ball0.mass = 2;
    ball0.x = 100;
    ball0.y = canv.height / 2;
    ball0.vx = 10;
    ball0.vy = Math.random() * 10 - 5;

    ball1.mass = 1;
    ball1.y = canv.height / 2;
    ball1.x = 500;
    ball1.vx = -10;
    ball1.vy = Math.random() * 10 - 5;


    function checkWalls(ball) {
        if(ball.x + ball.radius > canv.width){
            ball.x = canv.width - ball.radius;
            ball.vx *= bounce;
        }else if(ball.x - ball.radius < 0){
            ball.x = ball.radius;
            ball.vx *= bounce;
        }

        if(ball.y + ball.radius > canv.height){
            ball.y = canv.height - ball.radius;
            ball.vy *= bounce;
        }else if(ball.y - ball.radius < 0){
            ball.y = ball.radius;
            ball.vy *= bounce;
        }
    }

    function checkCollision(ball0, ball1) {
        var dx = ball0.x - ball1.x,
            dy = ball0.y - ball1.y,
            dist = Math.sqrt(dx * dx + dy * dy);
        if(dist < ball1.radius + ball0.radius){
            //计算两球之间的角度
            var angle = Math.atan2(dy, dx),
                sin = Math.sin(angle),
                cos = Math.cos(angle);

            //对小球的位置和速度进行坐标旋转
            //旋转后的位置是x0,y0 , x1,y1; 速度是 vx0,vy0, vx1, vy1;

            //以ball0作为"中心点"，所以它的坐标为（0，0），旋转后也不变；
            //旋转ball0后的位置
            var x0 = 0,
                y0 = 0;

            //旋转ball1后的位置
            var x1 = dx * cos + dy * sin,
                y1 = dy * cos - dx * sin;

            //旋转ball0的速度
            var vx0 = ball0.vx * cos + ball0.vy * sin,
                vy0 = ball0.vy * cos - ball0.vx * sin;

            //旋转ball1的速度
            var vx1 = ball1.vx * cos + ball1.vy + sin,
                vy1 = ball1.vy * cos - ball1.vx * sin;

            //旋转后 x轴上的碰撞
            var vxTotal = vx0 - vx1;
            vx0 = ((ball0.mass - ball1.mass) * vx0 + 2 * ball1.mass * vx1) / (ball0.mass + ball1.mass);
            vx1 = vxTotal + vx0;

            x0 += vx0;
            x1 += vx1;

            //计算完后，位置旋转归位，反旋转
            var x0Final = x0 * cos - y0 * sin,
                y0Final = y0 * cos + x0 * sin,
                x1Final = x1 * cos - y1 * sin,
                y1Final = y1 * cos + x1 * sin;

            //开始是相对于ball0(0,0)旋转，应该相对于ball0真正的位置
            //相对于实际屏幕的位置调整位置
            ball1.x = ball0.x + x1Final;
            ball1.y = ball0.y + y1Final;
            ball0.x = ball0.x + x0Final;
            ball0.y = ball0.y + y0Final;

            //速度旋转归位
            ball0.vx = vx0 * cos - vy0 * sin;
            ball0.vy = vy0 * cos + vx0 * sin;
            ball1.vx = vx1 * cos - vy1 * sin;
            ball1.vy = vy1 * cos + vx1 * sin;

        }
    }
    (function drawFram() {
        window.requestAnimationFrame(drawFram, canv);
        cxt.clearRect(0, 0, canv.width, canv.height);

        ball0.x += ball0.vx;
        ball0.y += ball0.vy;
        ball1.x += ball1.vx;
        ball1.y += ball1.vy;

        checkCollision(ball0, ball1);

        checkWalls(ball0);
        checkWalls(ball1);
        ball0.draw(cxt);
        ball1.draw(cxt);

    }())

</script>
</body>
</html>